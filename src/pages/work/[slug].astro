---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, getEntry } from 'astro:content';
import { getOptimizedImageUrl, generateSrcset, IMAGE_WIDTHS } from '../../lib/image';

export async function getStaticPaths() {
  const works = await getCollection('works');
  return works.map((work) => ({
    params: { slug: work.data.slug },
    props: { work },
  }));
}

const { work } = Astro.props;

// Get artwork details for each artwork reference in the series
// Reference fields store objects like { artwork: "src/content/artworks/artwork-id" }
const artworkPromises = work.data.artworks.map((item: { artwork: string }) => {
  // Extract the artwork ID from the reference path
  const artworkId = item.artwork?.split('/').pop() || '';
  return artworkId ? getEntry('artworks', artworkId) : null;
});
const artworks = (await Promise.all(artworkPromises)).filter(Boolean);
---

<BaseLayout title={`${work.data.title} - Mika Revell`}>
  <header class="mb-12 max-w-2xl">
    <h1 class="text-2xl lg:text-3xl font-semibold mb-2">{work.data.title}</h1>
    {work.data.subtitle && (
      <p class="text-text-muted italic">{work.data.subtitle}</p>
    )}
    {work.data.year && (
      <p class="text-text-muted">{work.data.year}</p>
    )}
    {work.data.description && (
      <p class="mt-4 text-text-muted">{work.data.description}</p>
    )}
  </header>

  <section class="space-y-8 lg:space-y-12 max-w-2xl">
    {artworks.map((artwork) => (
      <article id={artwork?.id} class="scroll-mt-20">
        <div class="bg-surface">
          <img
            src={getOptimizedImageUrl({ src: artwork?.data.image, width: 1024 })}
            srcset={generateSrcset(artwork?.data.image, IMAGE_WIDTHS.full)}
            sizes="(max-width: 672px) 100vw, 672px"
            alt={artwork?.data.title}
            class="w-full"
            loading="lazy"
            decoding="async"
          />
        </div>
        <div class="mt-4 space-y-1">
          <h2 class="text-lg">{artwork?.data.title}</h2>
          {artwork?.data.medium && (
            <p class="text-sm text-text-muted">{artwork?.data.medium}</p>
          )}
          {artwork?.data.dimensions && (
            <p class="text-sm text-text-muted">{artwork?.data.dimensions}</p>
          )}
          {artwork?.data.year && (
            <p class="text-sm text-text-muted">{artwork?.data.year}</p>
          )}
          {artwork?.data.description && (
            <p class="text-sm text-text-muted mt-2">{artwork?.data.description}</p>
          )}
        </div>
      </article>
    ))}
  </section>

  {artworks.length === 0 && (
    <div class="text-center py-20 text-text-muted">
      <p>No artworks in this series yet.</p>
    </div>
  )}
</BaseLayout>
